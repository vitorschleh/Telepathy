<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telepathy</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline'; 
                   style-src 'self' 'unsafe-inline'; 
                   connect-src 'self'; 
                   img-src 'self' data:; 
                   object-src 'none'; 
                   base-uri 'self';">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; overflow: hidden; height: 100vh; width: 100vw; font-family: monospace; }
        
        #menu-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background-color: #0a0a0a; color: #333;
        }
        #btn-performance {
            border: 1px solid #333; color: #444; background: transparent;
            padding: 20px 50px; font-size: 14px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        #stealth-layer {
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: black; z-index: 9999; cursor: none;
        }
    </style>

    <script>
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            location.replace(`https:${location.href.substring(location.protocol.length)}`);
        }

        // SEGURANÇA 2: BLOQUEIO DE POSTMESSAGE EXTERNO
        window.addEventListener("message", (event) => {
            if (event.origin !== window.location.origin) {
                console.warn("Tentativa de injeção bloqueada: " + event.origin);
                return; 
            }
        }, false);
    </script>
</head>
<body>

    <div id="menu-screen">
        <button id="btn-performance" onclick="ativarModoStealth()">Performance Mode</button>
        <div style="margin-top: 20px; font-size: 10px; color: #222;">v7.1 SECURE POST</div>
    </div>

    <div id="stealth-layer"></div>

    <script>
        // --- VARIÁVEIS ---
        let contagemToques = 0;
        let fase = "VALOR"; 
        let valorDetectado = "";
        let naipeDetectado = "";
        let touchStartX = 0;
        let touchStartY = 0;
        const layer = document.getElementById('stealth-layer');

        function ativarModoStealth() {
            if (navigator.vibrate) navigator.vibrate(10); 
            document.getElementById('menu-screen').style.display = 'none';
            layer.style.display = 'block';
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            }
        }

        // --- GESTOS ---
        layer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false});

        layer.addEventListener('touchend', (e) => {
            let touchEndX = e.changedTouches[0].screenX;
            let touchEndY = e.changedTouches[0].screenY;
            processarGesto(touchStartX, touchStartY, touchEndX, touchEndY);
        }, {passive: false});

        function processarGesto(startX, startY, endX, endY) {
            let diffX = endX - startX;
            let diffY = endY - startY;

            // 1. CLIQUE
            if (Math.abs(diffX) < 20 && Math.abs(diffY) < 20) {
                if (fase === "VALOR") { contarToque(); } 
                else if (fase === "NAIPE") { definirNaipe(endX, endY); }
            } 
            // 2. SWIPE DIREITA
            else if (diffX > 80 && Math.abs(diffY) < 60) { 
                if (fase === "VALOR" && contagemToques > 0) { confirmarValor(); }
            }
        }

        // --- LÓGICA ---
        function contarToque() {
            contagemToques++;
            if (navigator.vibrate) navigator.vibrate(50);
            console.log("Toque: " + contagemToques);
        }

        function confirmarValor() {
            // Mapeamento para letras (formato Cloudinary)
            const mapa = { 1: "A", 11: "J", 12: "Q", 13: "K" };
            valorDetectado = mapa[contagemToques] || contagemToques;
            
            fase = "NAIPE"; 
            console.log("Valor: " + valorDetectado);
        }

        function definirNaipe(x, y) {
            let w = window.innerWidth;
            let h = window.innerHeight;
            
            // --- MAPEAMENTO DOS NAIPES SÓLIDOS ---
            if (y < h / 2) {
                if (x < w / 2) naipeDetectado = "%E2%99%A0"; // Espadas (♠)
                else naipeDetectado = "%E2%99%A5";           // Copas (♥)
            } else {
                if (x < w / 2) naipeDetectado = "%E2%99%A3"; // Paus (♣)
                else naipeDetectado = "%E2%99%A6";           // Ouros (♦)
            }
            
            if (navigator.vibrate) navigator.vibrate(50);
            
            // Chama a nova função de envio corrigida
            enviarSilencioso();
        }

        // --- ENVIO SILENCIOSO CORRIGIDO (MÉTODO POST) ---
        async function enviarSilencioso() {
            // Cria o objeto exato que a Galeria espera
            const objetoMagico = {
                valor: valorDetectado,
                naipe: naipeDetectado
            };

            console.log("Enviando via POST: ", objetoMagico);

            try {
                const response = await fetch('/api/send', {
                    method: 'POST', // AGORA SIM: O Crachá Correto!
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        // O Pulo do Gato: Backend espera 'data' como string para salvar no Redis
                        data: JSON.stringify(objetoMagico)
                    })
                });

                if (response.ok) {
                    console.log("✅ Sucesso! Backend aceitou.");
                    if (navigator.vibrate) navigator.vibrate(200); // Vibra longo pra confirmar
                    resetarSistema();
                } else {
                    console.error("❌ Erro no backend: " + response.status);
                }
            } catch (err) {
                console.error("❌ Erro de conexão.", err);
            }
        }

        function resetarSistema() {
            contagemToques = 0;
            fase = "VALOR";
            valorDetectado = "";
            naipeDetectado = "";
        }

        // PWA REGISTER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
